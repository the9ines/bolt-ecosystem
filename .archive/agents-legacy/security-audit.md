# Security Audit

Security invariants and audit checklist for the Bolt ecosystem.

---

## Nonce Uniqueness Invariant

- Every encrypted envelope MUST use a fresh 24-byte random nonce.
- Nonce MUST be generated by a cryptographically secure random number generator (CSPRNG).
- Nonce MUST NOT be reused with the same ephemeral keypair.
- Nonce reuse with NaCl box breaks confidentiality and integrity.
- There is no nonce counter; randomness provides uniqueness.

---

## Ephemeral Key Lifecycle

- Fresh X25519 ephemeral keypair generated per connection.
- Used for all protected messages within that session.
- MUST NOT be rotated mid-session in v1.
- MUST be discarded on disconnection (provides forward secrecy).
- MUST NOT be persisted to disk.
- MUST NOT be reused across connections.

---

## TOFU Pinning Flow

- **First contact**: SHOULD prompt SAS verification. Pin key on acceptance.
- **Known key match**: proceed silently.
- **Key mismatch**: MUST send ENVELOPE(ERROR(KEY_MISMATCH)) and close session.
  - MUST present clear warning to user.
  - Re-pairing MUST delete old pinned key.
  - Re-pairing MUST store new key.
  - Re-pairing MUST require SAS confirmation.

This is fail-closed: mismatch always blocks, never falls through.

---

## Decrypt Failure Handling

- If decryption fails, receiver SHOULD send ENVELOPE(ERROR(ENCRYPTION_FAILED)).
- Receiver MAY terminate session without response if unsafe to reply.
- MUST NOT process message contents before MAC verification passes.
- MUST NOT silently ignore decrypt failures.

---

## Replay Protection

- Scoped per (transfer_id, chunk_index).
- Receiver MUST reject duplicate chunk_index for same transfer_id.
- Receiver MUST reject chunk_index >= total_chunks.
- Implementation MUST track received indices per active transfer.

---

## No Shortcuts List

These actions are unconditionally forbidden:

- [ ] Reuse a nonce with the same ephemeral keypair.
- [ ] Log or persist ephemeral secret keys.
- [ ] Log or persist identity secret keys.
- [ ] Log plaintext message contents in production.
- [ ] Skip MAC verification before processing.
- [ ] Weaken handshake gating (accept non-HELLO before handshake).
- [ ] Use identity key for bulk encryption.
- [ ] Use a non-CSPRNG for nonce generation.
- [ ] Send protected messages outside an envelope.
- [ ] Send ERROR outside an envelope.
- [ ] Allow auto-reconnect after KEY_MISMATCH without user re-pair.
- [ ] Trust rendezvous for confidentiality or integrity.
- [ ] Store ephemeral keys across sessions.

---

## PR Security Review Checklist

For any PR touching encryption, handshake, envelope, or key management:

- [ ] No nonce reuse possible in any code path.
- [ ] Ephemeral keys not persisted or logged.
- [ ] Identity secret keys not exposed in logs, errors, or wire messages.
- [ ] MAC verified before any plaintext processing.
- [ ] Handshake gating enforced (only HELLO/ERROR/PING/PONG before completion).
- [ ] TOFU mismatch path is fail-closed.
- [ ] file_hash only required when bolt.file-hash negotiated.
- [ ] Replay detection covers (transfer_id, chunk_index).
- [ ] No transport terms leaked into Core SDK code.
- [ ] Error messages do not leak key material or plaintext.
- [ ] SAS computed over raw bytes, not encoded strings.
- [ ] Envelope sender_ephemeral_key matches expected peer for session.

---

## Threat Model Summary

| Threat | Mitigation |
|--------|-----------|
| Rendezvous MITM | Detectable via SAS |
| Eavesdropping | NaCl box encryption |
| Replay | (transfer_id, chunk_index) dedup |
| File tampering | SHA-256 file_hash when negotiated |
| Identity impersonation | TOFU pinning + SAS |
| Key compromise (identity) | Forward secrecy via ephemeral keys |
| Nonce reuse | CSPRNG per envelope |
| Traffic analysis | Not mitigated (non-goal) |
